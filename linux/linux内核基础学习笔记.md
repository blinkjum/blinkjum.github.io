# linux内核基础学习笔记

## Linux内核简介

### 内核概述：

​		 内核指的是一个提供硬件抽象层、磁盘及文件系统控制、多任务等功能的系统软件。内核是一个操作系统的核心，是操作系统最基本的部分。它负责管理系统的进程、内存、设备驱动程序、文件和网络系统等，决定着系统的性能和稳定性。它是为众多应用程序提供对计算机硬件的安全访问的一部分软件，这种访问是有限的，并且内核决定一个程序在什么时候对某部分硬件操作多长时间。直接对硬件操作是非常复杂的，所以内核通常提供一种硬件抽象的方法来完成这些操作。硬件抽象隐藏了复杂性，为应用软件和硬件提供了一套简洁，统一的接口，使程序设计更为简单。 

### 内核作用：

​       **进程管理**：内核负责创建和销毁进程, 并处理它们与外部世界的联系(输入和输出)，不同进程间通讯(通过信号，管道，或者进程间通讯原语)对整个系统功能来说是基本的，也由内核处理。 另外， 调度器， 控制进程如何共享CPU，是进程管理的一部分。更通常地，内核的进程管理活动实现了多个进程在一个单个或者几个CPU 之上的抽象。

​        **内存管理**：计算机的内存是主要的资源， 处理它所用的策略对系统性能是至关重要的。内核为所有进程的每一个都在有限的可用资源上建立了一个虚拟地址空间。内核的不同部分与内存管理子系统通过一套函数调用交互，从简单的malloc/free对到更多更复杂的功能。

​       **文件管理**：Linux 在很大程度上基于文件系统的概念;几乎Linux中的任何东西都可看作一个文件。内核在非结构化的硬件之上建立了一个结构化的文件系统，结果是文件的抽象非常多地在整个系统中应用。另外，Linux 支持多个文件系统类型，就是说，物理介质上不同的数据组织方式。例如，磁盘可被格式化成标准Linux的ext3文件系统，普遍使用的FAT文件系统，或者其他几个文件系统。

​       **驱动管理**：几乎每个系统操作终都映射到一个物理设备上，除了处理器，内存和非常少的别的实体之外，全部中的任何设备控制操作都由特定于要寻址的设备相关的代码来进行。这些代码称为设备驱动。内核中必须嵌入系统中出现的每个外设的驱动，从硬盘驱动到键盘和磁带驱动器。

​       **网络管理**：网络必须由操作系统来管理，因为大部分网络操作不是特定于某一个进程： 进入系统的报文是异步事件。报文在某一个进程接手之前必须被收集，识别，分发，系统负责在程序和网络接口之间递送数据报文，它必须根据程序的网络活动来控制程序的执行。另外，所有的路由和地址解析问题都在内核中实现。

linux内核：单内核，模块化设计，抢占式内核，支持内核线程以动态装载内核模块。

### 内核版本：

主版本号.从版本号.修订版本,从版本号为偶数为稳定版本，奇数为开发中版本

3328内核版本4.19.193，uname -a 查看 

## 从内核出发

### 获取内核源码

linux内核官方网站https://www.kernel.org/

内核资料网站https://docs.kernel.org/index.html

### 内核源码树

![image-20220421212304829](.\resource\内核代码根目录描述.png)

### 编译内核

#### 配置内核

````shell
make config
````

遍历所有配置项，让用户选择yes、no或者module(如果是三态配置)，耗时不友好

````shell
make xconfig
````
基于X11的图形工具
````shell
make gconfig
````
基于gtk+图形工具
````shell
make defconfig
````
创建默认配置

#### 编译内核

make

运行make进行编译，可以支持多线程编译make -jn

减少不必要的log输出：make > ../some_other_file 或者 make > /dev/null

#### 安装内核

make module_install

### 内核开发特点

内核开发和用户空间内应用程序开发区别：

#### 内核编程时不能访问C库

标准C库的大小和执行效率不能被接受

大部分常用C库函数在内核内得到实现，printk和printf

#### 内核编程时必须使用GNU C

内联函数：减少跳转带来的开销，但是会增大代码体积，占用更多内存空间和指令缓存

内联汇编：支持在C中嵌入汇编语言

分支声明：likely()和unlikely()



#### 内核编程时缺乏像用户空间那样的内存保护机制

非法访问内存会导致oops，内核内存不分页，每用掉一个字节物理内存就减少一个字节

#### 内核编程时浮点数很难使用

内核并不能完美支持浮点操作，不要在内核中使用浮点数

#### 内核只有一个很小的定长堆栈

#### 内核支持异步中断、抢占和SMP，需要时刻注意同步和并发

内核很容易产生竞争条件，

Linux是抢占多任务操作系统，内核进程调度程序即兴对进程进行调度和重新调度

Linux内核支持多处理器系统，两个或者两个以上处理器中运行的代码可能会同时访问同一资源

中断是异步到来的，中断有可能访问当前代码正在访问的共享资源

linux内核是可抢占的，有可能应为抢占，导致几段代码同时访问相同资源

内核中大量使用了自旋锁和信号量

#### 开发时要考虑可移植性

## 模块

尽管Linux是"单块内核“(monolithic)的操作系统--这是说整个系统内核都运行于一个单独的保护域中，但是linux内核是模块化组成的，它允许内核在运行时动态地向其中插入或从中删除代码。这些代码(包括相关的子线程、数据、函数入口和函数出口)被一并组合在一个单独的二进制镜像中，即所谓的可装载内核模块中，或简称为模块。支持模块的好处是基本内核镜像尽可能的小，因为可选的功能和驱动程序可以利用模块形式再提供。模块允许我们方便地删除和重新载入内核代码，也方便了调试工作。而且当热插拔新设备时，可通过命令载入新的驱动程序。

module_init()宏调用，在模块装载时被调用，参数是模块的初始化函数，必须符合

````c
int my_init(void);
````

的形式，可以标记为static

module_exit()宏调用，在模块被卸载时调用，退出函数必须符合 

````c
void my_exit(void);
````
的形式，可以标记为static，如果是build in，退出函数不会编进内核，因为不需要卸载

MODULE_LICENSE()宏用于指定模块的版权

MODULE_AUTHOR()宏指定代码作者

### 构建模块

#### 放在内核源码树中

通过kbuild构建系统构建，修改/添加Kconfig和Makefile

#### 放在内核源码树外

建立Makefile，要告诉make如何找到内核源代码文件和基础Makefile文件

### 安装模块

````shell
make modules_install
````
### 产生模块依赖性

depmod命令：产生内核依赖关系信息

````shell
depmod -A 
````
只为新模块生成依赖信息

### 载入模块

````shell
insmod modulename
````

请求内核载入指定模块，部执行依赖分析和错误检查

````shell
rmmod modulename
````

卸载指定模块

modprobe module [module parameters]

提供模块依赖分析、错误检查、错误报告
````shell
modprobe -r modules
````
卸载模块和模块所依赖的相关模块

### 管理配置选项

例子：
````c

config LEDS_LM3530

tristate "LCD Backlight driver for LM3530"

depends on LEDS_CLASS

depends on I2C

help

 This option enables support for the LCD backlight using

 LM3530 ambient light sensor chip. This ALS chip can be

 controlled manually or using PWM input or using ambient

 light automatically.
````


LEDS_LM3530：配置选项的名称，省略了前缀"CONFIG_"

**Tristate**：

表示该项是否编进内核、编成模块。显示为< > , 假如选择编译成内核模块，则会在.config中生成一个 CONFIG_HELLO_MODULE=m的配置，选择Y就是直接编进内核，会在.config中生成一个 CONFIG_HELLO_MODULE=y的配置项。Tristate后的字符串是make menuconfig时显示的配置项名称。

**bool**：

此类型只能选中或不选中，make menuconfig时显示为[ ]，即无法配置成模块。

**dependon:**

该选项依赖于另一个选项，只有当依赖项被选中时，当前配置项的提示信息才会出现，才能设置当前配置项。

**select:**

反向依赖关系，该选项选中时，同时选中select后面定义的那一项。

**help**：

帮助信息

**目录层次迭代 ：**

Kconfig中有类似语句：source "drivers/usb/Kconfig" ，用来包含（或嵌套）新的Kconfig文件，使得各个目录管理各自的配置内容，不必把那些配置都写在同一个文件里，方便修改和管理

### 模块参数

宏module_param(name, type, perm);

参数name既是用户可见的参数名，也是模块中存放模块参数的变量名，参数type则存放模块类型，可以是byte、short、ushort、int、uint、long、ulong、charp、bool、或者invbool，最后一个参数perm指定了模块在sysfs文件系统下对应的文件权限

有可能模块外部参数名称不同于它对应的内部变量名称，使用宏

module_param_named(name, variable, type, perm);

## 调试

### printk()

printk()几乎可以在任何时候，任何地方调用，终端未初始化之前可以使用early_printk()

内核根据printk()指定的记录等级来判断是否要在终端上打印消息

![image-20220422074503141](.\resource\printk记录等级.png)

使用环形队列缓冲区存储打印信息

### dump_stack()

当内核出现比较严重的错误时，例如发生Oops错误或者内核认为系统运行状态异常，内核就会打印出当前进程的栈回溯信息，其中包含当前执行代码的位置以及相邻的指令、产生错误的原因、关键寄存器的值以及函数调用关系等信息，这些信息对于调试内核错误非常有用。

打印函数调用关系的函数就是dump_stack()，该函数不仅可以用在系统出问题的时候，我们在调试内核的时候，可以通过dump_stack()函数的打印信息更方便的了解内核代码执行流程。
dump_stack()函数的实现和系统结构紧密相关，本文介绍ARM体系中dump_stack()函数的实现。该函数定义在arch/arm/kernel/traps.c文件中，调用dump_stack()函数不需要添加头文件，基本上在内核代码任何地方都可以直接使用该函数。
````c
[  124.787924] CPU: 1 PID: 1741 Comm: insmod Not tainted 4.19.193 #11
[  124.787935] Hardware name: Rockchip RK3328 EVB avb (DT)
[  124.787947] Call trace:
[  124.787967]  dump_backtrace+0x0/0x158
[  124.78console:/storage/emulated/0 #7 982]  show_stack+0x14/0x1c
[  124.787997]  dump_stack+0xb8/0xf0
[  124.788014]  init_module+0x98/0xfc0 [helloworld]
[  124.788028]  do_one_initcall+0x110/0x26c
[  124.788043]  do_init_module+0x5c/0x1f8
[  124.788056]  load_module+0x2dcc/0x358c
[  124.788069]  __arm64_sys_finit_module+0xb0/0xe0
[  124.788086]  el0_svc_common+0x98/0x160
[  124.788098]  el0_svc_handler+0x5c/0x64
[  124.788108]  el0_svc+0x8/0xc
````
### oops

oops是内核遇到错误时发出的提示“声音”，oops有时候会触发panic，有时候不会，而是直接杀死当前进程，系统可以继续运行。

比如说内核态下的段错误，当内核设置了panic_on_oops=1的时候，oops会触发panic。【panic_on_oops的值在内核编译的时候配置，可以在/proc/sys/kernel/panic_on_oops查看值，同时可以使用sysctl修改】

当panic_on_oops=0的时候，如果错误发生在中断上下文，oops也会触发panic。如果错误只是发生在进程上下文，这个时候只需要kill当前进程。【中断上下文包括以下情况：硬中断、软中断、NMI】。

oops的时候内核还可以运行，只是可能不稳定，这个时候，内核会调用printk打印输出内核栈的信息和寄存器的信息。

```c
[  263.336138] Unable to handle kernel NULL pointer dereference at virtual address 00000000
[  263.342790] pgd = d4a44000
[  263.345467] [00000000] *pgd=566db831, *pte=00000000, *ppte=00000000
[  263.351708] Internal error: Oops: 817 [#1] PREEMPT SMP
[  263.356826] Modules linked in: hello(+)
[  263.360647] CPU: 0    Not tainted  (3.0.15 #20)
[  263.365165] PC is at hello_init+0x18/0x20 [hello]
[  263.369856] LR is at do_one_initcall+0x3c/0x190
[  263.374361] pc : [<bf002018>]    lr : [<c003e684>]    psr: 60000013
[  263.374365] sp : d4a17f18  ip : d4a17f28  fp : d4a17f24
[  263.385817] r10: 00000000  r9 : d4a16000  r8 : c0045ae8
[  263.391025] r7 : 0000534b  r6 : 00000000  r5 : bf000034  r4 : c096f840
[  263.397536] r3 : 00000000  r2 : 00000001  r1 : d4a17f28  r0 : 00000000
[  263.404047] Flags: nZCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user
[  263.411163] Control: 10c5387d  Table: 54a4404a  DAC: 00000015
[  263.416891] 
[  263.416893] LR: 0xc003e604:
....................
....................
```

### BUG() BUG_ON()

通过系统调用引发oops进行标记bug，调试追踪
````c
if (bad_thing)
	BUG();
````


````c
BUG_ON(bad_thing);
````

````c

[ 2082.054543] ------------[ cut here ]------------
[ 2082.054558] kernel BUG at drivers/helloworld/helloworld.c:24!
[ 2082.054573] Internal error: Oops - BUG: 0 [#1] PREEMPT SMP
[ 2082.056899] Modules linked in: helloworld(+) bcmdhd [last unloaded: helloworld]
[ 2082.057545] Process insmod (pid: 1967, stack limit = 0x000000005e196099)
[ 2082.058134] CPU: 3 PID: 1967 Comm: insmod Not tainted 4.19.193 #11
[ 2082.058675] Hardware name: Rockchip RK3328 EVB avb (DT)
[ 2082.059141] pstate: 60400005 (nZCv daif +PAN -UAO)
[ 2082.059568] pc : init_module+0xb4/0xfc0 [helloworld]
[ 2082.060014] lr : init_module+0xb4/0xfc0 [helloworld]
[ 2082.060455] sp : ffffff800e6abaf0
[ 2082.060755] x29: ffffff800e6abaf0 x28: ffffff800e6abdd0 
[ 2082.061231] x27: ffffffc033f44430 x26: 0000000000000027 
[ 2082.061696] x25: 00000000000009c0 x24: ffffff80099b2018 
[ 2082.062172] x23: ffffff8009c7db00 x22: 0000000000000000 
[ 2082.062638] x21: ffffffc028219d00 x20: ffffff8009c8b5d8 
[ 2082.063104] x19: ffffff800138e000 x18: 000000000000002c 
[ 2082.063570] x17: 0000000000000001 x16: 0000000000000007 
[ 2082.064036] x15: ffffff80094d1f57 x14: 0000000000000050 
[ 2082.064502] x13: 000000000004faae x12: 0000000000000000 
[ 2082.064968] x11: 0000000000000000 x10: 0000000000000007 
[ 2082.065434] x9 : 83fdca9a329db100 x8 : 83fdca9a329db100 
[ 2082.065901] x7 : 0000000000000000 x6 : ffffff8009cfb8f0 
[ 2082.066376] x5 : 0000000000000002 x4 : 000000000000000b 
[ 2082.066841] x3 : 000000000000001a x2 : 0000000000000007 
[ 2082.067308] x1 : 0000000000000007 x0 : 000000000000000a 
[ 2082.067774] 
[ 2082.067774] PC: 0xffffff8001391074:
[ 2082.068216] 1074  90ffffe0 9102f000 95b63d6c b0ffffe8 f9400501 90ffffe0 91031800 95b63d67
[ 2082.068942] 1094  b9400268 7100051f 54000160 7100091f 54000220 71000d1f 54000161 90ffffe0
[ 2082.069668] 10b4  9104a000 95b63d5d 90ffffe0 91039000 95b49a85 90ffffe0 9103dc00 95b63d57
[ 2082.070392] 10d4  95efe801 f9400bf3 2a1f03e0 a8c27bfd d65f03c0 90ffffe0 9102c000 95b63d4f
[ 2082.071116] 10f4  d4210000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.071840] 1114  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.072564] 1134  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.073287] 1154  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.074011] 
[ 2082.074011] LR: 0xffffff8001391074:
[ 2082.074453] 1074  90ffffe0 9102f000 95b63d6c b0ffffe8 f9400501 90ffffe0 91031800 95b63d67
[ 2082.075177] 1094  b9400268 7100051f 54000160 7100091f 54000220 71000d1f 54000161 90ffffe0
[ 2082.075901] 10b4  9104a000 95b63d5d 90ffffe0 91039000 95b49a85 90ffffe0 9103dc00 95b63d57
[ 2082.076625] 10d4  95efe801 f9400bf3 2a1f03e0 a8c27bfd d65f03c0 90ffffe0 9102c000 95b63d4f
[ 2082.077349] 10f4  d4210000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.078073] 1114  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.078797] 1134  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.079521] 1154  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.080245] 
[ 2082.080245] SP: 0xffffff800e6aba70:
[ 2082.080687] ba70  099b2018 ffffff80 000009c0 00000000 00000027 00000000 33f44430 ffffffc0
[ 2082.081411] ba90  0e6abdd0 ffffff80 0e6abaf0 ffffff80 013910f4 ffffff80 0e6abaf0 ffffff80
[ 2082.082136] bab0  013910f4 ffffff80 60400005 00000000 0e6aba98 ffffff80 329db100 83fdca9a
[ 2082.082860] bad0  ffffffff 0000007f 329db100 83fdca9a 0e6abaf0 ffffff80 013910f4 ffffff80
[ 2082.083583] baf0  0e6abc10 ffffff80 08084338 ffffff80 01391040 ffffff80 00000000 00000000
[ 2082.084307] bb10  0e6abb80 ffffff80 0830028c ffffff80 32c056e8 ffffffc0 00000000 00000000
[ 2082.085031] bb30  02d90310 ffffffc0 00000000 ffffff80 00000000 ffffff80 329db100 83fdca9a
[ 2082.085756] bb50  0e6abb80 ffffff80 08f92054 ffffff80 0e6abbd0 ffffff80 08247a80 ffffff80
[ 2082.086483] 
[ 2082.086483] X6: 0xffffff8009cfb870:
[ 2082.086926] b870  00000000 00000000 00000000 00000000 00000000 00000000 3c06a700 ffffffc0
[ 2082.087650] b890  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.088375] b8b0  00000000 00000000 00000001 00000000 085ab784 ffffff80 09ce8330 ffffff80
[ 2082.089098] b8d0  00000064 00000000 000147b4 000147b4 0000ffff 00000001 09cfb8f0 ffffff80
[ 2082.089821] b8f0  5b205d30 525f5442 4c494b46 203a5d4c 73207462 20747568 2066666f 65776f70
[ 2082.090545] b910  205b0a72 38352020 3731382e 5d303737 54425b20 4b46525f 5d4c4c49 6672203a
[ 2082.091269] b930  6c6c696b 5f6b725f 5f746573 65776f70 73203a72 62207465 61772074 685f656b
[ 2082.091994] b950  2074736f 68676968 205b0a21 38352020 3539382e 5d303735 54425b20 4b46525f
[ 2082.092721] 
[ 2082.092721] X15: 0xffffff80094d1ed7:
[ 2082.093163] 1ed4  00000000 00000000 00000000 00000000 00000000 7373696d 20676e69 5f504143
[ 2082.093888] 1ef4  5f535953 494d4441 6163204e 69626170 7974696c 76657500 20746e65 7373656d
[ 2082.094612] 1f14  20656761 206f6f74 00676962 00140009 0026001d 004c0043 01440055 00000000
[ 2082.095336] 1f34  005b0000 006f0065 00830079 0096008c 140e0000 14141014 14141414 01141214
[ 2082.096060] 1f54  12001414 19191919 19191919 19191919 19191919 19191919 19191919 19191919
[ 2082.096784] 1f74  19191919 19191919 19191919 19191919 19191919 193e1919 19191919 19191919
[ 2082.097507] 1f94  19002019 00191919 19191919 19292719 41193119 00381919 00423e38 5d1f5d48
[ 2082.098231] 1fb4  4e2c5d0e 325d5d54 7b755d00 5d5d5d5d 5d5d5d5d 8e895d5d 005d975d 5d1fa39d
[ 2082.098955] 1fd4  5d2c5d5d 325d5d5d 5d5d5d00 26c40a5d 766d1526 0000f1c4 31151500 008c8c31
[ 2082.099682] 
[ 2082.099682] X19: 0xffffff800138df80:
[ 2082.100124] df80  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.100848] dfa0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.101572] dfc0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.102296] dfe0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.103019] e000  00000002 00000022 24319710 ffffffc0 000030e4 ffffeff0 00000018 00000000
[ 2082.103743] e020  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.104467] e040  00000001 00000000 010c2908 ffffff80 09ca3b90 ffffff80 6c6c6568 726f776f
[ 2082.105191] e060  0000646c 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.105916] 
[ 2082.105916] X20: 0xffffff8009c8b558:
[ 2082.106359] b558  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.107083] b578  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.107807] b598  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.108531] b5b8  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.109254] b5d8  09c8b5d8 ffffff80 09c8b5d8 ffffff80 00000022 756e694c 00000078 00000000
[ 2082.109979] b5f8  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.110703] b618  00000000 00000000 00000000 00000000 00000000 636f6c00 6f686c61 00007473
[ 2082.111426] b638  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.112152] 
[ 2082.112152] X21: 0xffffffc028219c80:
[ 2082.112594] 9c80  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.113318] 9ca0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.114042] 9cc0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.114766] 9ce0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.115489] 9d00  04000020 00000000 ffffffff ffffffff 1a200000 03160000 00000001 00000000
[ 2082.116213] 9d20  00000000 00000000 0e6a8000 ffffff80 00000002 00400100 00000000 00000000
[ 2082.116938] 9d40  00000000 00000000 00000001 00000003 0000000a 00000000 0008284f 00000001
[ 2082.117661] 9d60  3c3d6580 ffffffc0 00000003 00000003 00000001 00000078 00000078 00000078
[ 2082.118387] 
[ 2082.118387] X23: 0xffffff8009c7da80:
[ 2082.118829] da80  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.119553] daa0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.120276] dac0  00000002 00000001 329db100 83fdca9a ffffffff 00000000 00000000 00000000
[ 2082.121000] dae0  000008ff 00000000 0037b0d6 00000000 0000001f 00010100 00000000 00000000
[ 2082.121724] db00  0000000f 00000000 0000000f 00000000 0000000f 00000000 0000000f 00000000
[ 2082.122448] db20  00000000 00000000 00000000 00000000 0a2d2600 ffffffc0 0a2d2800 ffffffc0
[ 2082.123172] db40  0a2d2a00 ffffffc0 0a2d2c00 ffffffc0 0a2d2e00 ffffffc0 0a2d3000 ffffffc0
[ 2082.123896] db60  0a2d3200 ffffffc0 017ed73b 00000020 00000001 00000000 0a2e2000 ffffffc0
[ 2082.124621] 
[ 2082.124621] X24: 0xffffff80099b1f98:
[ 2082.125064] 1f98  ******** ******** ******** ******** ******** ******** ******** ********
[ 2082.125795] 1fb8  ******** ******** ******** ******** ******** ******** ******** ********
[ 2082.126521] 1fd8  ******** ******** ******** ******** ******** ******** ******** ********
[ 2082.127248] 1ff8  ******** ******** ******** ******** ******** ******** ******** ********
[ 2082.127974] 2018  ******** ******** ******** ******** ******** ******** ******** ********
[ 2082.128699] 2038  ******** ******** ******** ******** ******** ******** ******** ********
[ 2082.129425] 2058  ******** ******** ******** ******** ******** ******** ******** ********
[ 2082.130151] 2078  ******** ******** ******** ******** ******** ******** ******** ********
[ 2082.130880] 
[ 2082.130880] X27: 0xffffffc033f443b0:
[ 2082.131323] 43b0  2b7a7500 ffffffc0 00000100 00000000 00000013 00000000 00000000 00000000
[ 2082.132048] 43d0  0816731c ffffff80 00000000 00000000 00000000 00000000 01392000 ffffff80
[ 2082.132772] 43f0  2b7a7900 ffffffc0 00000100 00000000 00000013 00000000 00000000 00000000
[ 2082.133495] 4410  0816731c ffffff80 00000000 00000000 00000000 00000000 01392630 ffffff80
[ 2082.134219] 4430  33f44030 ffffffc0 33f44070 ffffffc0 33f440b0 ffffffc0 33f440f0 ffffffc0
[ 2082.134943] 4450  33f44130 ffffffc0 33f44170 ffffffc0 33f441b0 ffffffc0 33f441f0 ffffffc0
[ 2082.135667] 4470  33f44230 ffffffc0 33f44270 ffffffc0 33f442b0 ffffffc0 33f442f0 ffffffc0
[ 2082.136391] 4490  33f44330 ffffffc0 33f44370 ffffffc0 33f443b0 ffffffc0 33f443f0 ffffffc0
[ 2082.137116] 
[ 2082.137116] X28: 0xffffff800e6abd50:
[ 2082.137559] bd50  0e6abe40 ffffff80 08161cac ffffff80 28219d00 ffffffc0 00000000 00000000
[ 2082.138283] bd70  00000000 00000000 56000000 00000000 00000015 00000000 00000000 00000000
[ 2082.139007] bd90  28219d00 ffffffc0 00000003 00000000 00000000 00000000 76d28818 0000005d
[ 2082.139731] bdb0  0e7ac000 ffffff80 0000d1a0 00000000 0e7ac745 ffffff80 0e7b7800 ffffff80
[ 2082.140456] bdd0  0e7ac000 ffffff80 0000d1a0 00000000 0e7b87e0 ffffff80 0e7b83b8 ffffff80
[ 2082.141180] bdf0  0e7b85ae ffffff80 00003000 00000000 000031e0 00000000 00000000 00000000
[ 2082.141904] be10  00000000 00000000 00001860 00000000 00000024 00000026 0000001f 00000021
[ 2082.142628] be30  00000011 00000000 329db100 83fdca9a 0e6abe70 ffffff80 08098c98 ffffff80
[ 2082.143353] 
[ 2082.143353] X29: 0xffffff800e6aba70:
[ 2082.143797] ba70  099b2018 ffffff80 000009c0 00000000 00000027 00000000 33f44430 ffffffc0
[ 2082.144522] ba90  0e6abdd0 ffffff80 0e6abaf0 ffffff80 013910f4 ffffff80 0e6abaf0 ffffff80
[ 2082.145246] bab0  013910f4 ffffff80 60400005 00000000 0e6aba98 ffffff80 329db100 83fdca9a
[ 2082.145970] bad0  ffffffff 0000007f 329db100 83fdca9a 0e6abaf0 ffffff80 013910f4 ffffff80
[ 2082.146694] baf0  0e6abc10 ffffff80 08084338 ffffff80 01391040 ffffff80 00000000 00000000
[ 2082.147417] bb10  0e6abb80 ffffff80 0830028c ffffff80 32c056e8 ffffffc0 00000000 00000000
[ 2082.148141] bb30  02d90310 ffffffc0 00000000 ffffff80 00000000 ffffff80 329db100 83fdca9a
[ 2082.148865] bb50  0e6abb80 ffffff80 08f92054 ffffff80 0e6abbd0 ffffff80 08247a80 ffffff80
[ 2082.149589] 
[ 2082.149725] Call trace:
[ 2082.149953]  init_module+0xb4/0xfc0 [helloworld]
[ 2082.150367]  do_one_initcall+0x110/0x26c
[ 2082.150715]  do_init_module+0x5c/0x1f8
[ 2082.151049]  load_module+0x2dcc/0x358c
[ 2082.151384]  __arm64_sys_finit_module+0xb0/0xe0
[ 2082.151785]  el0_svc_common+0x98/0x160
[ 2082.152121]  el0_svc_handler+0x5c/0x64
[ 2082.152456]  el0_svc+0x8/0xc
[ 2082.152716] Code: d65f03c0 90ffffe0 9102c000 95b63d4f (d4210000) 
[ 2082.153259] ---[ end trace 2db3e1c9f39c740f ]---
[ 2082.172225] Kernel panic - not syncing: Fatal exception
[ 2082.172697] SMP: stopping secondary CPUs
[ 2082.173047] PMU:
[ 2082.173226] 00000000: 00009560 00000000 00000000 00000000 00001555 00005555 00000005 00000000
[ 2082.173979] 00000020: 00000a15 00000200 00000000 00000000 00000000 0000aa0a 00000000 00000000
[ 2082.174733] 00000040: 00000000 00000000 00002aaa 00000000 00000001 00000000 00000000 00000000
[ 2082.175487] 00000060: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.176241] 00000080: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.176995] 000000a0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.177748] 000000c0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.178502] 000000e0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.179249] Kernel Offset: disabled
[ 2082.179562] CPU features: 0x00000000,20002004
[ 2082.179948] Memory Limit: none
[ 2082.180238] rockchip-thermal ff250000.tsadc: channal 0: temperature(45 C)
[ 2082.180834] THERMAL REGS:
[ 2082.181074] 00000000: 00000200 00010013 00000101 00000000 00000000 00000000 00000000 00000000
[ 2082.181828] 00000020: 000001d1 00000000 00000000 00000000 0000023c 00000000 00000000 00000000
[ 2082.182581] 00000040: 00000293 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[ 2082.183335] 00000060: 00000004 00000004 000000fa 00000032 00000000 00000000 00000000 00000000
[ 2082.184084] 00000080: 00000000 00000000
[ 2082.203133] Rebooting in 5 seconds..
````
### panic()

内核遇到严重错误时触发，打印调试信息，系统挂起

````c
[   69.991182] Kernel panic - not syncing: i am panic message
[   69.992898] CPU: 0 PID: 1610 Comm: insmod Not tainted 4.19.193 #11
[   69.993438] Hardware name: Rockchip RK3328 EVB avb (DT)
[   69.993902] Call trace:
[   69.994133]  dump_backtrace+0x0/0x158
[   69.994459]  show_stack+0x14/0x1c
[   69.994761]  dump_stack+0xb8/0xf0
[   69.995064]  panic+0x12c/0x2a4
[   69.995347]  init_module+0x88/0xfc0 [helloworld]
[   69.995759]  do_one_initcall+0x110/0x26c
[   69.996106]  do_init_module+0x5c/0x1f8
[   69.996441]  load_module+0x2dcc/0x358c
[   69.996775]  __arm64_sys_finit_module+0xb0/0xe0
[   69.997176]  el0_svc_common+0x98/0x160
[   69.997512]  el0_svc_handler+0x5c/0x64
[   69.997846]  el0_svc+0x8/0xc
[   69.998107] SMP: stopping secondary CPUs
[   69.998460] PMU:
[   69.998638] 00000000: 00009560 00000000 00000000 00000000 00001555 00005555 00000005 00000000
[   69.999392] 00000020: 00000a15 00000200 00000000 00000000 00000000 0000aa0a 00000000 00000000
[   70.000147] 00000040: 00000000 00000000 00002aaa 00000000 00000001 00000000 00000000 00000000
[   70.000901] 00000060: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[   70.001655] 00000080: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[   70.002409] 000000a0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[   70.003162] 000000c0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[   70.003915] 000000e0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[   70.004664] Kernel Offset: disabled
[   70.004976] CPU features: 0x00000000,20002004
[   70.005364] Memory Limit: none
[   70.005652] rockchip-thermal ff250000.tsadc: channal 0: temperature(49 C)
[   70.006247] THERMAL REGS:
[   70.006488] 00000000: 00000200 00010013 00000101 00000000 00000000 00000000 00000000 00000000
[   70.007243] 00000020: 000001d5 00000000 00000000 00000000 0000023c 00000000 00000000 00000000
[   70.007997] 00000040: 00000293 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[   70.008751] 00000060: 00000004 00000004 000000fa 00000032 00000000 00000000 00000000 00000000
[   70.009501] 00000080: 00000000 00000000
[   70.023885] Rebooting in 5 seconds..

````

### SysRq

**基本原理**
Sysrq实现的基本原理为：在键盘或串口驱动中(如果是/proc接口方式，则直接定义/proc的相关写入接口即可)，对按键进行判断过滤，然后根据不同的按键进行相应的处理。普通键盘和串口的流程不尽相同，主要差别在键盘和串口驱动的具体实现上，总体流程一致。
对于普通键盘来说 ，其底层的处理(从硬件中断到键盘驱动)过程依赖于内核中的输入(input)子系统。键盘处理的大致流程如下：
1）键盘中断调用中断服务程序
2）键盘中断服务程序调用输入子系统
3）输入子系统调用键盘设备对应的键盘事件处理器
4）键盘事件处理器完成键码的转换分类工作，根据按键类型的不同，执行不同的操作。对于输入类按键，先将按键值存放到临时缓冲区，激活临时缓冲区的工作队列，然后结束。对于控制类按键，激活对应此次控制操作的工作队列，然后结束。
5）系统在适当的时机调度工作队列执行，完成剩下的操作
而Sysrq魔术键的处理比较特殊，在内核主分支的代码中，在上述步骤4中的键盘事件处理器中进行相应的处理，不依赖于工作队列，相当于直接在硬件中断中处理。而在3.10内核版本的分支代码中，处理流程不太一样，其合入了相应的补丁，使sysrq的处理剥离出来，放在input子系统进行处理，而脱离了键盘事件的处理流程，其还是在中断上下文中处理的，不依赖于工作队列等。主要是通过注册input_handler实现，具体见后面的代码分析。
另一方面，对于串口设备来说，其sysrq的处理流程根据各串口驱动的实现而稍有不同，但基本都是直接在硬件中断中直接处理的。
所以，总的来说，sysrq魔术键基本都在中断上下文中处理，优先级很高，能在关键时刻发挥重要作用。

![image-20220422081200256](.\resource\sysrq.png)

**使用方式**

通常有两种方式：a、通过/proc接口；b、通过键盘输入组合键
通过键盘组合键输入的规则是：
串口：按住break键，然后5秒内输入command字符
键盘：alt + sysrq +command键
下面是通过/proc实现意义的说明。
立即重启计算机 echo “b” > /proc/sysrq-trigger
立即关闭计算机 echo “o” > /proc/sysrq-trigger
导出内存分配的信息 echo “m” > proc/sysrq-trigger (可以用/var/log/message查看)Outputs memory statistics to the console
导出当前CPU寄存器信息和标志位的信息 echo “p” > proc/sysrq-trigger (outputs all flags and registers to the console)
导出线程状态信息 echo “t” > proc/sysrq-trigger (outputs a list of processes to the console)
故意让系统崩溃 echo “c” > proc/sysrq-trigger (crashes the system without first unmounting file systems or syncing disks attached to the system)
立即重新挂载所有的文件系统 echo “s” > proc/sysrq-trigger (attempts to sync disks attached to the system)
立即重新挂载所有的文件系统为只读 echo “u” > proc/sysrq-trigger (attempts to unmount and remount all file systems as read-only)
此外，还有两个类似于强制注销的功能
e ---- kills all processes except init using SIGTERM
i ---- kills all processes except init using SIGKILL

